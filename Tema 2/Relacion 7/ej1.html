<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Ubicación con Leaflet (Simplificado JSDoc)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* CSS mínimo para que el mapa se muestre */
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>

<body>

    <h1>Mi Ubicación Actual</h1>
    <p id="status">Verificando geolocalización...</p>

    <div id="map"></div>

    <script>
        // Variables globales necesarias
        let map;
        const statusElement = document.getElementById('status');

        /**
         * Inicializa y centra el mapa Leaflet en las coordenadas dadas.
         * Añade la capa base de OpenStreetMap y un marcador.
         * * @param {number} lat Latitud.
         * @param {number} lon Longitud.
         * @param {number} [zoom=15] Nivel de zoom inicial.
         */
        function initializeLeafletMap(lat, lon, zoom = 15) {
            // 1. Inicializa el mapa si aún no existe
            if (!map) {
                map = L.map('map').setView([lat, lon], zoom);
            } else {
                // Si ya existe, solo reajusta la vista
                map.setView([lat, lon], zoom);
            }

            // 2. Añade la capa base de OpenStreetMap (Tiles)
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // 3. Añade un marcador en la ubicación
            L.marker([lat, lon])
                .addTo(map)
                .bindPopup("Estás aquí")
                .openPopup();
        }

        /**
         * Función de éxito de geolocalización.
         * Procesa las coordenadas y llama a initializeLeafletMap.
         * * @param {GeolocationPosition} position Objeto con las coordenadas.
         */
        function successCallback(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            statusElement.textContent = `Ubicación obtenida: Latitud ${lat.toFixed(6)}, Longitud ${lon.toFixed(6)}`;
            statusElement.style.color = 'green';

            // Llama a la inicialización del mapa con la posición obtenida
            initializeLeafletMap(lat, lon);
        }

        /**
         * Función de error de geolocalización.
         * Muestra un mensaje de error y centra el mapa en el globo por defecto (0, 0).
         * * @param {GeolocationPositionError} error Objeto con la información del error.
         */
        function errorCallback(error) {
            statusElement.textContent = "❌ Error al obtener la ubicación. Asegúrate de dar permiso.";
            statusElement.style.color = 'red';

            // Centra en el centro del mapa mundial si falla la geolocalización
            initializeLeafletMap(0, 0, 2);
        }

        // Punto de Entrada: Ejecutar al cargar la página
        window.onload = function () {
            // 1. Verifica si el navegador soporta la API de Geolocalización
            if (navigator.geolocation) {
                statusElement.textContent = "Geolocalización disponible. Solicitando posición...";

                // 2. Llama a getCurrentPosition con las funciones de éxito y error
                navigator.geolocation.getCurrentPosition(
                    successCallback,
                    errorCallback
                );
            } else {
                statusElement.textContent = "Su navegador no soporta la API de Geolocalización.";
                // Muestra el mapa global de todos modos
                initializeLeafletMap(0, 0, 2);
            }
        };

    </script>

</body>

</html>